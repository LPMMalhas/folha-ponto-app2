<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Ponto</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel para transpilar JSX no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- HTML2PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* Estilos adicionais */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        /* Esconde scrollbar em modais mas permite rolagem */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Animação suave */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef, useCallback } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        
        // Imports do Firebase (Versão Modular via CDN)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot
        } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // Imports Lucide React
        import { 
            Clock, Settings, ChevronLeft, ChevronRight, TrendingUp, AlertCircle, Banknote,
            FileText, FileDown, Wallet, Database, Upload, Save, X, MinusCircle,
            DollarSign, ToggleLeft, ToggleRight, PiggyBank, History, Calendar, Trash2, CheckCircle
        } from 'https://esm.sh/lucide-react@0.294.0';

        // --- CONFIGURAÇÃO FIREBASE (PRODUÇÃO) ---
        // Estas credenciais permitem que o app funcione em qualquer lugar (Github Pages, etc)
        const firebaseConfig = {
            apiKey: "AIzaSyDv87FD9oZI80G2ioM0PqHDalt2cwrQbIk",
            authDomain: "controle-de-ponto-741c2.firebaseapp.com",
            projectId: "controle-de-ponto-741c2",
            storageBucket: "controle-de-ponto-741c2.firebasestorage.app",
            messagingSenderId: "67388186352",
            appId: "1:67388186352:web:0d71a4c2d441c794172c35"
        };

        const appId = 'app-controle-ponto-v1';

        let db;
        let auth;

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.warn("Erro na inicialização do Firebase.", e);
        }

        // --- CONFIGURAÇÕES PADRÃO ---
        const DEFAULT_CONFIG = {
            dailyTargetMonThu: "08:48", 
            dailyTargetFri: "08:00",    
            useTimeBank: true,          
            defaultStart: "07:00",
            defaultLunchStart: "12:00",
            defaultLunchEnd: "13:00",
            defaultEndMonThu: "17:30",
            defaultEndFri: "16:00",
            companyName: "Minha Empresa",
            employeeName: "Colaborador",
            savedMonths: [] // Lista para rastrear histórico explicitamente
        };

        // --- FUNÇÕES UTILITÁRIAS ---
        const timeToMinutes = (timeStr) => {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return (hours * 60) + minutes;
        };

        const minutesToTime = (totalMinutes) => {
            if (totalMinutes === undefined || totalMinutes === null || isNaN(totalMinutes)) return "00:00";
            const isNegative = totalMinutes < 0;
            const absMinutes = Math.abs(totalMinutes);
            const hours = Math.floor(absMinutes / 60);
            const minutes = absMinutes % 60;
            const formatted = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            return isNegative ? `-${formatted}` : formatted;
        };

        const formatCurrency = (value) => {
            if (value === undefined || value === null || isNaN(value)) return "R$ 0,00";
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        const getDayName = (dateStr) => {
            const days = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
            const date = new Date(dateStr + 'T00:00:00'); 
            return days[date.getDay()];
        };

        const isWeekend = (dateStr) => {
            const date = new Date(dateStr + 'T00:00:00');
            const day = date.getDay();
            return day === 0 || day === 6; 
        };

        function App() {
            const [user, setUser] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date());
            
            // Estados de Dados
            const [records, setRecords] = useState({});
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [financials, setFinancials] = useState({}); 

            // Refs para evitar loops de dependência
            const recordsRef = useRef({});
            const configRef = useRef(DEFAULT_CONFIG);
            const financialsRef = useRef({});

            // Atualiza refs quando state muda
            useEffect(() => { recordsRef.current = records; }, [records]);
            useEffect(() => { configRef.current = config; }, [config]);
            useEffect(() => { financialsRef.current = financials; }, [financials]);

            // Estados de UI
            const [showConfig, setShowConfig] = useState(false);
            const [showFinancial, setShowFinancial] = useState(false);
            const [showBackup, setShowBackup] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [isExporting, setIsExporting] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            
            const reportRef = useRef(null);
            const fileInputRef = useRef(null);

            const currentMonthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;

            // --- AUTENTICAÇÃO ---
            useEffect(() => {
                if (!auth) return;
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Erro na autenticação:", error);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            // --- SINCRONIZAÇÃO DE DADOS (Leitura Inteligente) ---
            useEffect(() => {
                if (!user || !db) return;

                const recordsDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'records');
                const configDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'config');
                const financialsDoc = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'financials');

                const unsubRecords = onSnapshot(recordsDoc, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (JSON.stringify(data) !== JSON.stringify(recordsRef.current)) {
                            setRecords(data);
                        }
                    } else {
                         if (Object.keys(recordsRef.current).length > 0) setRecords({});
                    }
                });

                const unsubConfig = onSnapshot(configDoc, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (JSON.stringify(data) !== JSON.stringify(configRef.current)) {
                             setConfig({ ...DEFAULT_CONFIG, ...data });
                        }
                    }
                });

                const unsubFinancials = onSnapshot(financialsDoc, (docSnap) => {
                     if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (JSON.stringify(data) !== JSON.stringify(financialsRef.current)) {
                             setFinancials(data);
                        }
                    } else {
                        if (Object.keys(financialsRef.current).length > 0) setFinancials({});
                    }
                });

                return () => {
                    unsubRecords();
                    unsubConfig();
                    unsubFinancials();
                };
            }, [user]);

            // --- SALVAMENTO (Escrita com Debounce e Manual) ---
            const saveToFirebase = async (docName, data) => {
                if (!user || !db) return;
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', docName), data);
                } catch (e) {
                    console.error(`Erro ao salvar ${docName}:`, e);
                }
            };

            // Autosave com Debounce
            useEffect(() => { 
                if (Object.keys(records).length === 0 && Object.keys(recordsRef.current).length === 0) return;
                const timeoutId = setTimeout(() => { if (user) saveToFirebase('records', records); }, 1500);
                return () => clearTimeout(timeoutId);
            }, [records, user]);
            
            useEffect(() => { 
                 const timeoutId = setTimeout(() => { if (user) saveToFirebase('config', config); }, 1500);
                 return () => clearTimeout(timeoutId);
            }, [config, user]);

            useEffect(() => { 
                 const timeoutId = setTimeout(() => { if (user) saveToFirebase('financials', financials); }, 1500);
                 return () => clearTimeout(timeoutId);
            }, [financials, user]);


            // --- LÓGICA DE NEGÓCIO ---
            const getDaysForMonth = (year, monthIndex) => {
                const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                const days = [];
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayString = String(i).padStart(2, '0');
                    const monthString = String(monthIndex + 1).padStart(2, '0');
                    days.push(`${year}-${monthString}-${dayString}`);
                }
                return days;
            };

            const getDaysInMonth = () => getDaysForMonth(currentDate.getFullYear(), currentDate.getMonth());

            const handleInputChange = (date, field, value) => {
                setRecords(prev => ({ ...prev, [date]: { ...prev[date], [field]: value } }));
            };

            const getEffectiveValues = (date) => {
                const record = records[date] || {};
                if (isWeekend(date)) {
                    return {
                        entry1: record.entry1 || "", exit1: record.exit1 || "",
                        entry2: record.entry2 || "", exit2: record.exit2 || "",
                        extraEntry: record.extraEntry || "", extraExit: record.extraExit || ""
                    };
                }
                const dayOfWeek = new Date(date + 'T00:00:00').getDay();
                const isFri = dayOfWeek === 5;
                return {
                    entry1: record.entry1 !== undefined ? record.entry1 : config.defaultStart,
                    exit1: record.exit1 !== undefined ? record.exit1 : config.defaultLunchStart,
                    entry2: record.entry2 !== undefined ? record.entry2 : config.defaultLunchEnd,
                    exit2: record.exit2 !== undefined ? record.exit2 : (isFri ? config.defaultEndFri : config.defaultEndMonThu),
                    extraEntry: record.extraEntry || "", extraExit: record.extraExit || ""
                };
            };

            const calculateDayStats = (date) => {
                const values = getEffectiveValues(date);
                const e1 = timeToMinutes(values.entry1);
                const s1 = timeToMinutes(values.exit1);
                const e2 = timeToMinutes(values.entry2);
                const s2 = timeToMinutes(values.exit2);

                let worked = 0;
                if (values.entry1 && values.exit1) worked += (s1 - e1);
                if (values.entry2 && values.exit2) worked += (s2 - e2);

                const eExtra = timeToMinutes(values.extraEntry);
                const sExtra = timeToMinutes(values.extraExit);
                let extraManual = 0;
                if (values.extraEntry && values.extraExit) extraManual = sExtra - eExtra;

                const dayOfWeek = new Date(date + 'T00:00:00').getDay();
                let target = 0;
                if (dayOfWeek === 0 || dayOfWeek === 6) target = 0;
                else if (dayOfWeek === 5) target = timeToMinutes(config.dailyTargetFri);
                else target = timeToMinutes(config.dailyTargetMonThu);

                return { worked, target, balance: worked - target, manualExtra: extraManual };
            };

            const calculateMonthTotalBalance = (year, monthIndex) => {
                const days = getDaysForMonth(year, monthIndex);
                let monthBalance = 0;
                days.forEach(day => {
                    const stats = calculateDayStats(day);
                    if (!isWeekend(day) || stats.worked > 0) monthBalance += stats.balance;
                });
                return monthBalance;
            };

            const getMonthStats = () => {
                let totalWorked = 0;
                let totalBalance = 0;
                let totalManualExtras = 0;
                let totalDailySurplus = 0; 
                let totalDailyDeficit = 0; 

                const days = getDaysInMonth();
                days.forEach(day => {
                    const stats = calculateDayStats(day);
                    const values = getEffectiveValues(day);
                    const hasData = values.entry1 || values.entry2 || values.extraEntry;
                    totalManualExtras += stats.manualExtra;

                    if (!isWeekend(day) || hasData) {
                        totalWorked += stats.worked;
                        totalBalance += stats.balance;
                        if (stats.balance > 0) totalDailySurplus += stats.balance;
                        if (stats.balance < 0) totalDailyDeficit += stats.balance;
                    }
                });
                
                let displayExtras = totalManualExtras;
                if (!config.useTimeBank) displayExtras += totalDailySurplus;

                return { totalWorked, totalBalance, totalManualExtras, totalDailySurplus, totalDailyDeficit, displayExtras };
            };

            const yearStatsMemo = useMemo(() => {
                const year = currentDate.getFullYear();
                const currentMonthIndex = currentDate.getMonth();
                let totalYearBalance = 0;
                for (let m = 0; m <= currentMonthIndex; m++) {
                    const monthBal = calculateMonthTotalBalance(year, m);
                    if (config.useTimeBank) totalYearBalance += monthBal;
                }
                return { totalYearBalance };
            }, [currentDate, records, config]); 

            const getPriorBankBalance = useMemo(() => {
                if (!config.useTimeBank) return 0;
                const year = currentDate.getFullYear();
                const currentMonthIndex = currentDate.getMonth();
                let priorBalance = 0;
                for (let m = 0; m < currentMonthIndex; m++) {
                    const monthBal = calculateMonthTotalBalance(year, m);
                    priorBalance += monthBal; 
                }
                return Math.max(0, priorBalance);
            }, [currentDate, records, config]);

            const handleFinancialChange = (field, value) => {
                const numValue = value === "" ? 0 : parseFloat(value);
                setFinancials(prev => ({
                    ...prev,
                    [currentMonthKey]: { ...(prev[currentMonthKey] || {}), [field]: numValue }
                }));
            };

            const getCurrentFinancials = () => {
                const defaults = { baseSalary: 0, normalHourValue: 0, overtimeHourValue: 0, bonus: 0, freqPremium: 0, transportAid: 0, loans: 0, food: 0, merch: 0, others: 0 };
                return { ...defaults, ...(financials[currentMonthKey] || {}) };
            };

            const getFinancialTotals = () => {
                const fin = getCurrentFinancials();
                const stats = getMonthStats();
                const priorBankBalance = getPriorBankBalance;
                const totalAdditions = fin.bonus + fin.freqPremium + fin.transportAid;

                let totalExtrasValue = 0;
                let bankDeduction = 0;
                let absorbedByBank = 0;
                let netExtrasMinutes = 0;

                if (config.useTimeBank) {
                    const extraHoursDecimal = stats.totalManualExtras / 60;
                    totalExtrasValue = extraHoursDecimal * fin.overtimeHourValue;
                    
                    if (stats.totalBalance < 0) {
                        const deficitMinutes = Math.abs(stats.totalBalance);
                        if (priorBankBalance >= deficitMinutes) {
                            absorbedByBank = deficitMinutes;
                            bankDeduction = 0; 
                        } else {
                            absorbedByBank = priorBankBalance;
                            const remainingDeficit = deficitMinutes - priorBankBalance;
                            bankDeduction = (remainingDeficit / 60) * fin.normalHourValue;
                        }
                    }
                } else {
                    const totalPositiveMinutes = stats.displayExtras; 
                    const totalNegativeMinutes = Math.abs(stats.totalDailyDeficit);
                    
                    if (totalPositiveMinutes >= totalNegativeMinutes) {
                        netExtrasMinutes = totalPositiveMinutes - totalNegativeMinutes;
                        bankDeduction = 0; 
                    } else {
                        netExtrasMinutes = 0;
                        const remainingDeficit = totalNegativeMinutes - totalPositiveMinutes;
                        bankDeduction = (remainingDeficit / 60) * fin.normalHourValue;
                    }
                    totalExtrasValue = (netExtrasMinutes / 60) * fin.overtimeHourValue;
                }

                const totalWorkedDecimal = stats.totalWorked / 60;
                const valueOfWorkedHours = totalWorkedDecimal * fin.normalHourValue;
                const valueOfBankHours = config.useTimeBank 
                    ? (stats.totalBalance / 60) * fin.overtimeHourValue 
                    : (netExtrasMinutes / 60) * fin.overtimeHourValue;

                const totalDiscounts = fin.loans + fin.food + fin.merch + fin.others + bankDeduction;
                const estimatedTotal = fin.baseSalary + totalExtrasValue + totalAdditions - totalDiscounts;

                return { fin, totalAdditions, totalDiscounts, totalExtrasValue, estimatedTotal, bankDeduction, valueOfWorkedHours, valueOfBankHours, absorbedByBank };
            };

            // --- ACTIONS ---
            const handleManualSave = async () => {
                setIsSaving(true);
                try {
                    // Adiciona o mês atual à lista de salvos explicitamente
                    const currentMonthStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                    const newSavedMonths = [...(config.savedMonths || [])];
                    if (!newSavedMonths.includes(currentMonthStr)) {
                        newSavedMonths.push(currentMonthStr);
                    }
                    
                    const newConfig = { ...config, savedMonths: newSavedMonths };
                    setConfig(newConfig);

                    // Força o salvamento imediato
                    await saveToFirebase('records', records);
                    await saveToFirebase('financials', financials);
                    await saveToFirebase('config', newConfig);
                    
                    setTimeout(() => {
                        setIsSaving(false);
                        alert(`Sucesso! Os dados de ${currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })} foram salvos e já constam no histórico.`);
                    }, 500);
                } catch (error) {
                    console.error("Erro ao salvar manualmente:", error);
                    setIsSaving(false);
                    alert("Erro ao salvar. Verifique sua conexão.");
                }
            };

            const handleBackup = () => {
                const data = { records, config, financials, exportDate: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const safeName = config.employeeName ? config.employeeName.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'funcionario';
                const dateStr = new Date().toISOString().split('T')[0];
                a.download = `backup_ponto_${safeName}_${dateStr}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };
            
            const handleReset = async () => {
                if (confirm("ATENÇÃO: Isso APAGARÁ todos os dados do funcionário atual para cadastrar um novo.\n\nVocê já fez o BACKUP do funcionário atual?\n\nClique em OK para limpar tudo.")) {
                    try {
                        if (user && db) {
                            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'records'), {});
                            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'config'), DEFAULT_CONFIG);
                            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'financials'), {});
                        }
                        setRecords({});
                        setConfig(DEFAULT_CONFIG);
                        setFinancials({});
                        alert("Sistema limpo com sucesso! Pode cadastrar o novo funcionário.");
                        setShowBackup(false);
                    } catch (e) {
                        console.error(e);
                        alert("Erro ao limpar dados. Tente recarregar a página.");
                    }
                }
            }

            const handleRestoreClick = () => fileInputRef.current.click();

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.records) setRecords(data.records);
                        if (data.config) setConfig(data.config);
                        if (data.financials) setFinancials(data.financials);
                        alert("Backup restaurado com sucesso!");
                        setShowBackup(false);
                    } catch (err) { alert("Erro ao ler arquivo de backup."); }
                };
                reader.readAsText(file);
            };

            const changeMonth = (offset) => {
                const newDate = new Date(currentDate);
                newDate.setMonth(newDate.getMonth() + offset);
                setCurrentDate(newDate);
            };
            
            // --- HISTÓRICO ---
            const getAvailableMonths = useMemo(() => {
                const months = new Set(config.savedMonths || []); // Inicia com os salvos explicitamente
                
                // Adiciona também os que têm dados (para retrocompatibilidade)
                Object.keys(records).forEach(date => {
                    const r = records[date];
                    if (r && (r.entry1 || r.exit1 || r.entry2 || r.exit2 || r.extraEntry || r.extraExit)) {
                        months.add(date.substring(0, 7)); // YYYY-MM
                    }
                });

                return Array.from(months).sort().reverse().map(monthStr => {
                    const [y, m] = monthStr.split('-').map(Number);
                    const bal = calculateMonthTotalBalance(y, m - 1);
                    return { key: monthStr, year: y, monthIndex: m - 1, balance: bal };
                });
            }, [records, config.savedMonths]);

            const handleHistorySelect = (year, monthIndex) => {
                const newDate = new Date(year, monthIndex, 1);
                setCurrentDate(newDate);
                setShowHistory(false);
            };

            const handlePdfDownload = () => {
                if (!window.html2pdf) return alert("Carregando biblioteca PDF...");
                setIsExporting(true);
                setTimeout(() => {
                    const element = reportRef.current;
                    const opt = {
                        margin: [5, 5, 5, 5],
                        filename: `ponto_${config.employeeName.replace(/\s+/g, '_')}_${currentMonthKey}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };
                    window.html2pdf().set(opt).from(element).save().then(() => setIsExporting(false));
                }, 100);
            };

            const generateReportText = () => {
                const days = getDaysInMonth();
                const { fin, totalDiscounts, totalExtrasValue, estimatedTotal, bankDeduction, absorbedByBank } = getFinancialTotals();
                const totals = getMonthStats();

                let text = `RELATÓRIO DE PONTO - ${currentMonthKey}\n`;
                text += `Colaborador: ${config.employeeName} | Empresa: ${config.companyName}\n`;
                text += `Regime: ${config.useTimeBank ? 'Banco de Horas' : 'Pagamento Mensal'}\n\n`;
                text += `DATA | DIA | ENT1 | SAI1 | ENT2 | SAI2 | EXT.ENT | EXT.SAI | SALDO\n`;
                text += `----------------------------------------------------------------------\n`;
                days.forEach(day => {
                    const vals = getEffectiveValues(day);
                    const stats = calculateDayStats(day);
                    if (!isWeekend(day) || stats.worked > 0 || stats.manualExtra > 0) {
                        text += `${day.split('-')[2]} | ${getDayName(day).substring(0,3)} | ${vals.entry1||'--'} | ${vals.exit1||'--'} | ${vals.entry2||'--'} | ${vals.exit2||'--'} | ${vals.extraEntry||'--'} | ${vals.extraExit||'--'} | ${minutesToTime(stats.balance)}\n`;
                    }
                });
                text += `\n--- RESUMO DE HORAS ---\n`;
                text += `TRABALHADO: ${minutesToTime(totals.totalWorked)}\n`;
                
                if (config.useTimeBank) {
                    text += `EXTRAS (PAGAS): ${minutesToTime(totals.totalManualExtras)}\n`;
                    text += `BANCO MÊS: ${minutesToTime(totals.totalBalance)}\n`;
                    if(absorbedByBank > 0) text += `ABATIDO BANCO: ${minutesToTime(absorbedByBank)}\n`;
                } else {
                    const totalPositiveMinutes = totals.displayExtras; 
                    const totalNegativeMinutes = Math.abs(totals.totalDailyDeficit);
                    let netExtras = 0;
                    let netDeficit = 0;
                    if (totalPositiveMinutes >= totalNegativeMinutes) {
                        netExtras = totalPositiveMinutes - totalNegativeMinutes;
                    } else {
                        netDeficit = totalNegativeMinutes - totalPositiveMinutes;
                    }
                    text += `EXTRAS TOTAIS: ${minutesToTime(totalPositiveMinutes)}\n`;
                    text += `FALTAS TOTAIS: ${minutesToTime(totalNegativeMinutes)}\n`;
                    text += `EXTRAS LÍQUIDAS (PAGAS): ${minutesToTime(netExtras)}\n`;
                    text += `FALTAS LÍQUIDAS (DESC): ${minutesToTime(netDeficit)}\n`;
                }

                text += `\n--- FINANCEIRO ---\n`;
                text += `Salário Base: ${formatCurrency(fin.baseSalary)}\n`;
                text += `Extras: ${formatCurrency(totalExtrasValue)}\n`;
                text += `Adicionais: ${formatCurrency(fin.bonus + fin.freqPremium + fin.transportAid)}\n`;
                text += `Descontos Diversos: -${formatCurrency(totalDiscounts - bankDeduction)}\n`;
                text += `Desc. Faltas: -${formatCurrency(bankDeduction)}\n`;
                text += `LÍQUIDO ESTIMADO: ${formatCurrency(estimatedTotal)}\n`;
                return text;
            };

            const handleDownloadTxt = () => {
                const text = generateReportText();
                const element = document.createElement("a");
                const file = new Blob([text], {type: 'text/plain'});
                element.href = URL.createObjectURL(file);
                element.download = `ponto_${config.employeeName}_${currentMonthKey}.txt`;
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };

            const stats = getMonthStats();
            const yearStats = yearStatsMemo;
            const days = getDaysInMonth();
            const { fin: currentFin, totalAdditions, totalDiscounts, totalExtrasValue, estimatedTotal, bankDeduction, valueOfWorkedHours, valueOfBankHours, absorbedByBank } = getFinancialTotals();

            // Styles
            const appBgClass = isExporting ? "bg-white" : "bg-slate-50";
            const headerClass = isExporting ? "bg-white text-black border-b-2 border-black p-4" : "bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-10";
            const inputClass = isExporting ? "border-none bg-transparent text-black font-mono text-center w-full text-[10px]" : "w-full p-1 text-sm bg-slate-50 border border-slate-200 rounded text-center focus:ring-1 focus:ring-blue-500 focus:outline-none";

            if (!auth || !user) {
                return (
                    <div className="flex h-screen items-center justify-center font-sans text-slate-600 flex-col gap-4">
                        <div className="w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <p>Carregando Sistema...</p>
                    </div>
                );
            }

            return (
                <div className={`min-h-screen font-sans ${appBgClass} text-slate-800`}>
                    {/* WRAPPER PDF (A4) */}
                    <div ref={reportRef} id="report-content" className={isExporting ? "p-6 max-w-[210mm] mx-auto" : ""}>
                        {/* HEADER */}
                        <header className={headerClass}>
                        <div className="max-w-4xl mx-auto">
                            <div className="flex justify-between items-start mb-2">
                            <div>
                                <h1 className={`font-bold uppercase ${isExporting ? 'text-xl' : 'text-xl flex items-center gap-2'}`}>
                                {!isExporting && <Clock className="w-6 h-6" />} 
                                {isExporting ? config.companyName : "Controle de Ponto"}
                                </h1>
                                <p className={`text-sm ${isExporting ? 'text-black' : 'text-blue-200'}`}>
                                {isExporting ? `Relatório de Frequência - ${config.employeeName}` : config.employeeName}
                                </p>
                            </div>
                            
                            {!isExporting && (
                                <div className="flex gap-2">
                                <button onClick={handleManualSave} className="p-2 bg-emerald-600 hover:bg-emerald-500 rounded-full flex items-center gap-2 px-3 transition-all" title="Salvar Folha Atual">
                                    {isSaving ? <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> : <Save className="w-5 h-5" />}
                                    <span className="hidden sm:inline text-xs font-bold">Salvar Folha</span>
                                </button>
                                <button onClick={() => setShowHistory(true)} className="p-2 bg-blue-800 hover:bg-blue-700 rounded-full" title="Histórico de Meses"><History className="w-5 h-5" /></button>
                                <button onClick={() => setShowBackup(true)} className="p-2 bg-blue-800 hover:bg-blue-700 rounded-full" title="Backup / Trocar Funcionário"><Database className="w-5 h-5" /></button>
                                <button onClick={() => setShowFinancial(true)} className="p-2 bg-blue-800 hover:bg-blue-700 rounded-full" title="Financeiro"><Wallet className="w-5 h-5" /></button>
                                <button onClick={handlePdfDownload} className="p-2 bg-blue-800 hover:bg-blue-700 rounded-full" title="Baixar PDF"><FileDown className="w-5 h-5" /></button>
                                <button onClick={() => setShowConfig(!showConfig)} className="p-2 hover:bg-blue-800 rounded-full" title="Configurações"><Settings className="w-5 h-5" /></button>
                                </div>
                            )}
                            
                            {isExporting && (
                                <div className="text-right text-xs">
                                <p className="font-bold">{currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase()}</p>
                                <p>Regime: {config.useTimeBank ? "Banco de Horas" : "Mensalista"}</p>
                                </div>
                            )}
                            </div>

                            {!isExporting && (
                            <div className="flex justify-between items-center bg-blue-800 rounded-lg p-2 mb-4">
                                <button onClick={() => changeMonth(-1)} className="p-1 hover:bg-blue-700 rounded"><ChevronLeft/></button>
                                <span className="font-semibold text-lg capitalize">{currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</span>
                                <button onClick={() => changeMonth(1)} className="p-1 hover:bg-blue-700 rounded"><ChevronRight/></button>
                            </div>
                            )}

                            {/* SEÇÃO DE RESUMO (Aparece no topo no modo Exportação) */}
                            {isExporting && (
                            <div className="grid grid-cols-2 gap-4 mb-4 border border-black p-2 text-[10px]">
                                <div>
                                <h3 className="font-bold border-b border-black mb-1">RESUMO DE HORAS</h3>
                                <div className="grid grid-cols-2 gap-x-4">
                                    <p>TRABALHADO: <b>{minutesToTime(stats.totalWorked)}</b></p>
                                    
                                    {config.useTimeBank ? (
                                    <>
                                        <p>EXTRAS (PAGAS): <b>{minutesToTime(stats.totalManualExtras)}</b></p>
                                        <p>BANCO MÊS: <b>{minutesToTime(stats.totalBalance)}</b></p>
                                        <p>BANCO ANO: <b>{minutesToTime(yearStats.totalYearBalance)}</b></p>
                                        {absorbedByBank > 0 && <p>ABATIDO BANCO: {minutesToTime(absorbedByBank)}</p>}
                                    </>
                                    ) : (
                                    <>
                                        <p>EXTRAS (TOTAIS): <b>{minutesToTime(stats.displayExtras)}</b></p>
                                        <p>FALTAS (TOTAIS): <b>{minutesToTime(Math.abs(stats.totalDailyDeficit))}</b></p>
                                    </>
                                    )}
                                </div>
                                </div>
                                <div>
                                <h3 className="font-bold border-b border-black mb-1">RESUMO FINANCEIRO</h3>
                                <div className="grid grid-cols-2 gap-x-4">
                                    <p>SALÁRIO BASE: {formatCurrency(currentFin.baseSalary)}</p>
                                    <p>VALOR EXTRAS: {formatCurrency(totalExtrasValue)}</p>
                                    <p>ADICIONAIS: {formatCurrency(totalAdditions)}</p>
                                    <p>DESC. DIVERSOS: -{formatCurrency(totalDiscounts - bankDeduction)}</p>
                                    <p>DESC. FALTAS: -{formatCurrency(bankDeduction)}</p>
                                    <p className="font-bold mt-1">LÍQUIDO EST.: {formatCurrency(estimatedTotal)}</p>
                                </div>
                                </div>
                            </div>
                            )}

                            {/* Cards de Resumo (Apenas Modo App) */}
                            {!isExporting && (
                            <div className="grid grid-cols-2 gap-3 mb-2">
                                <div className="p-3 rounded-lg border bg-emerald-900/40 border-emerald-600 flex flex-col justify-center">
                                <p className="text-[10px] uppercase tracking-wider mb-1 text-emerald-100">{config.useTimeBank ? "Extras (Pagas/Manuais)" : "Extras (Totais)"}</p>
                                <p className="text-xl font-mono font-bold truncate text-white">{minutesToTime(stats.displayExtras)}</p>
                                </div>
                                <div className="p-3 rounded-lg border bg-blue-950/50 border-blue-700 flex flex-col justify-center">
                                <p className="text-[10px] uppercase tracking-wider mb-1 text-blue-200">Trabalhado</p>
                                <p className="text-xl font-mono font-bold truncate text-white">{minutesToTime(stats.totalWorked)}</p>
                                </div>
                                <div className="p-3 rounded-lg border bg-blue-900/40 border-blue-500 flex flex-col justify-center">
                                <p className="text-[10px] uppercase tracking-wider mb-1 text-white/80">{config.useTimeBank ? "Banco de Horas (Mês)" : "Saldo Horas (Mês)"}</p>
                                <div className="flex items-center gap-1">
                                    <p className="text-xl font-mono font-bold truncate text-white">
                                        {config.useTimeBank 
                                            ? (stats.totalBalance >= 0 ? '+' : '') + minutesToTime(stats.totalBalance) 
                                            : "---"}
                                    </p>
                                </div>
                                </div>
                                <div className="p-3 rounded-lg border bg-indigo-900/40 border-indigo-500 flex flex-col justify-center">
                                <p className="text-[10px] uppercase tracking-wider mb-1 text-white/80">{config.useTimeBank ? "Acumulado Ano (Positivo)" : "Faltas (Totais)"}</p>
                                <p className="text-xl font-mono font-bold truncate text-white">
                                    {config.useTimeBank ? (yearStats.totalYearBalance >= 0 ? '+' : '') + minutesToTime(yearStats.totalYearBalance) : minutesToTime(stats.totalDailyDeficit)}
                                </p>
                                </div>
                            </div>
                            )}

                            {/* Valores Calculados (Apenas Modo App) */}
                            {!isExporting && (
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                <div className="p-2 rounded-lg border flex flex-col justify-center bg-white/10 border-white/20">
                                    <p className="text-[10px] uppercase tracking-wider mb-1 flex items-center gap-1 text-blue-100">
                                    <DollarSign className="w-3 h-3" /> Valor Horas Trab.
                                    </p>
                                    <p className="text-lg font-mono font-bold truncate text-white">{formatCurrency(valueOfWorkedHours)}</p>
                                </div>
                                <div className="p-2 rounded-lg border flex flex-col justify-center bg-white/10 border-white/20">
                                    <p className="text-[10px] uppercase tracking-wider mb-1 flex items-center gap-1 text-blue-100">
                                    <DollarSign className="w-3 h-3" /> {config.useTimeBank ? "Valor Banco (Estimado)" : "Valor Extras (Líquido)"}
                                    </p>
                                    <p className="text-lg font-mono font-bold truncate text-white">{formatCurrency(valueOfBankHours)}</p>
                                </div>
                            </div>
                            )}
                        </div>
                        </header>

                        {/* LISTA DE DIAS */}
                        <main className={`max-w-4xl mx-auto ${isExporting ? '' : 'p-4 space-y-3 pb-24'}`}>
                        {isExporting && (
                            <div className="grid grid-cols-7 text-[9px] font-bold uppercase text-center border-b border-black mb-1 pb-1">
                                <div className="col-span-1 text-left">Dia</div>
                                <div>Entrada</div><div>Almoço</div><div>Volta</div><div>Saída</div><div>Ent. Extra</div><div>Sai. Extra</div>
                            </div>
                        )}

                        {days.map(day => {
                            const isWknd = isWeekend(day);
                            const dayStats = calculateDayStats(day);
                            const vals = getEffectiveValues(day);
                            const isToday = day === new Date().toISOString().split('T')[0];

                            if (isExporting) {
                            return (
                                <div key={day} className={`grid grid-cols-7 text-[9px] border-b border-gray-300 py-0.5 items-center ${isWknd ? 'bg-gray-100' : ''}`}>
                                    <div className="font-bold flex flex-col col-span-1 text-left pl-1">
                                    <span>{day.split('-')[2]} <span className="text-[7px] uppercase font-normal text-gray-500 ml-1">{getDayName(day).substring(0,3)}</span></span>
                                    </div>
                                    <div className="text-center">{vals.entry1}</div><div className="text-center">{vals.exit1}</div>
                                    <div className="text-center">{vals.entry2}</div><div className="text-center">{vals.exit2}</div>
                                    <div className="text-center font-bold text-gray-700">{vals.extraEntry}</div>
                                    <div className="text-center font-bold text-gray-700">{vals.extraExit}</div>
                                </div>
                            )
                            }

                            return (
                            <div key={day} className={`relative rounded-xl border transition-all duration-200 ${isToday ? 'ring-2 ring-blue-400 border-blue-400 bg-white shadow-md' : ''} ${isWknd ? 'bg-slate-100 border-slate-200 opacity-80' : 'bg-white border-slate-200 shadow-sm'}`}>
                                <div className="flex justify-between items-center p-3 bg-slate-50/50 rounded-t-xl border-b border-slate-100">
                                <div className="flex items-center gap-2">
                                    <span className={`font-bold text-lg ${isWknd ? 'text-slate-400' : 'text-slate-700'}`}>{day.split('-')[2]}</span>
                                    <span className="text-xs font-semibold uppercase text-slate-400 tracking-wide">{getDayName(day)}</span>
                                    {isToday && <span className="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full font-bold">HOJE</span>}
                                </div>
                                {!isWknd && (
                                    <div className={`text-xs font-bold px-2 py-1 rounded-md flex items-center gap-1 ${dayStats.balance >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {dayStats.balance >= 0 ? '+' : ''}{minutesToTime(dayStats.balance)}
                                    </div>
                                )}
                                </div>
                                <div className="p-3 grid grid-cols-6 gap-2">
                                <div className="space-y-1"><label className="text-[10px] text-slate-400 uppercase font-bold text-center block">Entrada</label><input type="time" value={vals.entry1} onChange={(e) => handleInputChange(day, 'entry1', e.target.value)} className={inputClass} disabled={isWknd}/></div>
                                <div className="space-y-1"><label className="text-[10px] text-slate-400 uppercase font-bold text-center block">Almoço</label><input type="time" value={vals.exit1} onChange={(e) => handleInputChange(day, 'exit1', e.target.value)} className={inputClass} disabled={isWknd}/></div>
                                <div className="space-y-1"><label className="text-[10px] text-slate-400 uppercase font-bold text-center block">Volta</label><input type="time" value={vals.entry2} onChange={(e) => handleInputChange(day, 'entry2', e.target.value)} className={inputClass} disabled={isWknd}/></div>
                                <div className="space-y-1"><label className="text-[10px] text-slate-400 uppercase font-bold text-center block">Saída</label><input type="time" value={vals.exit2} onChange={(e) => handleInputChange(day, 'exit2', e.target.value)} className={inputClass} disabled={isWknd}/></div>
                                <div className="space-y-1"><label className="text-[10px] text-emerald-600 uppercase font-bold text-center block">Ent. Extra</label><input type="time" value={vals.extraEntry} onChange={(e) => handleInputChange(day, 'extraEntry', e.target.value)} className={inputClass + " font-semibold text-emerald-700 bg-emerald-50 border-emerald-200"} /></div>
                                <div className="space-y-1"><label className="text-[10px] text-emerald-600 uppercase font-bold text-center block">Sai. Extra</label><input type="time" value={vals.extraExit} onChange={(e) => handleInputChange(day, 'extraExit', e.target.value)} className={inputClass + " font-semibold text-emerald-700 bg-emerald-50 border-emerald-200"} /></div>
                                </div>
                            </div>
                            );
                        })}
                        </main>
                        
                        {isExporting && (
                        <div className="mt-8 pt-4 border-t border-black flex justify-between text-xs">
                            <div className="text-center w-1/3">
                                <div className="border-b border-black mb-1 h-8"></div>
                                <p>Assinatura Colaborador</p>
                            </div>
                            <div className="text-center w-1/3">
                                <div className="border-b border-black mb-1 h-8"></div>
                                <p>Assinatura Responsável</p>
                            </div>
                        </div>
                        )}
                    </div>

                    {!isExporting && (
                        <div className="fixed bottom-6 right-6 flex flex-col gap-3">
                        <button onClick={handleDownloadTxt} className="bg-slate-600 text-white p-3 rounded-full shadow-lg hover:bg-slate-700 transition-transform hover:scale-105 flex items-center justify-center gap-2" title="Baixar TXT"><FileText className="w-5 h-5" /></button>
                        </div>
                    )}

                    {showFinancial && !isExporting && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 overflow-y-auto max-h-[90vh]">
                            <div className="flex justify-between items-center mb-4">
                            <h2 className="text-lg font-bold flex items-center gap-2 text-slate-700"><Banknote className="w-5 h-5" /> Financeiro (Mês)</h2>
                            <button onClick={() => setShowFinancial(false)} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5"/></button>
                            </div>
                            
                            <div className="space-y-3">
                            <div className="bg-blue-50 p-3 rounded border border-blue-200 mb-4">
                                <p className="text-xs text-blue-600 font-bold uppercase border-b border-blue-200 pb-1 mb-2">Dados Salariais</p>
                                <div className="space-y-2">
                                <div><label className="text-xs font-bold text-slate-600">Salário Base</label><input type="number" value={currentFin.baseSalary} onChange={(e) => handleFinancialChange('baseSalary', e.target.value)} className="w-full border p-1 rounded font-semibold"/></div>
                                <div className="grid grid-cols-2 gap-2">
                                    <div><label className="text-xs text-slate-500">Valor Hora Normal</label><input type="number" value={currentFin.normalHourValue} onChange={(e) => handleFinancialChange('normalHourValue', e.target.value)} className="w-full border p-1 rounded"/></div>
                                    <div><label className="text-xs text-slate-500">Valor Hora Extra</label><input type="number" value={currentFin.overtimeHourValue} onChange={(e) => handleFinancialChange('overtimeHourValue', e.target.value)} className="w-full border p-1 rounded"/></div>
                                </div>
                                </div>
                            </div>

                            <p className="text-xs text-slate-500 font-bold uppercase border-b pb-1">Acréscimos</p>
                            <div><label className="text-xs">Bonificação</label><input type="number" value={currentFin.bonus} onChange={(e) => handleFinancialChange('bonus', e.target.value)} className="w-full border p-1 rounded" /></div>
                            <div><label className="text-xs">Prêmio Frequência</label><input type="number" value={currentFin.freqPremium} onChange={(e) => handleFinancialChange('freqPremium', e.target.value)} className="w-full border p-1 rounded" /></div>
                            <div><label className="text-xs">Auxílio Transporte</label><input type="number" value={currentFin.transportAid} onChange={(e) => handleFinancialChange('transportAid', e.target.value)} className="w-full border p-1 rounded" /></div>

                            <p className="text-xs text-slate-500 font-bold uppercase border-b pb-1 mt-4">Descontos</p>
                            {absorbedByBank > 0 && (
                                <div className="flex justify-between items-center bg-blue-50 p-2 rounded border border-blue-200 mb-2">
                                <label className="text-xs font-bold text-blue-600 flex items-center gap-1"><PiggyBank className="w-3 h-3"/> Abatido do Banco</label>
                                <span className="text-xs font-bold text-blue-600">{minutesToTime(absorbedByBank)}</span>
                                </div>
                            )}
                            {bankDeduction > 0 && (
                                <div className="flex justify-between items-center bg-red-50 p-2 rounded border border-red-200 mb-2">
                                <label className="text-xs font-bold text-red-600 flex items-center gap-1"><MinusCircle className="w-3 h-3"/> Desc. Horas (Folha)</label>
                                <span className="text-xs font-bold text-red-600">{formatCurrency(bankDeduction)}</span>
                                </div>
                            )}
                            <div><label className="text-xs">Vales / Empréstimos</label><input type="number" value={currentFin.loans} onChange={(e) => handleFinancialChange('loans', e.target.value)} className="w-full border p-1 rounded" /></div>
                            <div><label className="text-xs">Marmitas / Alimentação</label><input type="number" value={currentFin.food} onChange={(e) => handleFinancialChange('food', e.target.value)} className="w-full border p-1 rounded" /></div>
                            <div><label className="text-xs">Mercadoria da Empresa</label><input type="number" value={currentFin.merch} onChange={(e) => handleFinancialChange('merch', e.target.value)} className="w-full border p-1 rounded" /></div>
                            <div><label className="text-xs">Outros</label><input type="number" value={currentFin.others} onChange={(e) => handleFinancialChange('others', e.target.value)} className="w-full border p-1 rounded" /></div>
                            
                            <div className="mt-4 p-3 bg-emerald-50 border border-emerald-200 rounded text-center">
                                <p className="text-xs text-emerald-600 uppercase font-bold">Total a Receber</p>
                                <p className="text-xl font-bold text-emerald-700">{formatCurrency(estimatedTotal)}</p>
                            </div>
                            </div>
                            <button onClick={() => setShowFinancial(false)} className="w-full bg-emerald-600 text-white p-2 rounded mt-4">Salvar e Fechar</button>
                        </div>
                        </div>
                    )}
                    
                    {/* HISTÓRICO MODAL */}
                    {showHistory && !isExporting && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 max-h-[80vh] flex flex-col">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-lg font-bold flex items-center gap-2 text-slate-700"><History className="w-5 h-5" /> Folhas Salvas</h2>
                                <button onClick={() => setShowHistory(false)} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5"/></button>
                            </div>
                            <p className="text-xs text-slate-500 mb-4">Selecione um mês abaixo para visualizar ou editar.</p>
                            
                            <div className="flex-1 overflow-y-auto space-y-2 pr-2">
                                {getAvailableMonths.length === 0 ? (
                                    <div className="text-center py-8 text-slate-400 bg-slate-50 rounded-lg">Nenhum registro encontrado.</div>
                                ) : (
                                    getAvailableMonths.map((m) => (
                                        <button 
                                            key={m.key} 
                                            onClick={() => handleHistorySelect(m.year, m.monthIndex)}
                                            className={`w-full text-left p-3 rounded-lg border transition-all flex justify-between items-center group hover:border-blue-500 hover:bg-blue-50 fade-in ${currentMonthKey === m.key ? 'border-blue-500 bg-blue-50 ring-1 ring-blue-500' : 'border-slate-200 bg-white'}`}
                                        >
                                            <div className="flex items-center gap-3">
                                                <div className="bg-blue-100 text-blue-600 p-2 rounded-lg group-hover:bg-blue-200 transition-colors">
                                                    <Calendar className="w-5 h-5" />
                                                </div>
                                                <div>
                                                    <p className="font-bold text-slate-700 capitalize">
                                                        {new Date(m.year, m.monthIndex, 1).toLocaleDateString('pt-BR', { month: 'long' })}
                                                    </p>
                                                    <p className="text-xs text-slate-500">{m.year}</p>
                                                </div>
                                            </div>
                                            <div className={`text-xs font-mono font-bold px-2 py-1 rounded ${m.balance >= 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                {m.balance >= 0 ? '+' : ''}{minutesToTime(m.balance)}
                                            </div>
                                        </button>
                                    ))
                                )}
                            </div>
                        </div>
                        </div>
                    )}

                    {showBackup && !isExporting && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
                            <div className="flex justify-between items-center mb-4">
                            <h2 className="text-lg font-bold flex items-center gap-2 text-slate-700"><Database className="w-5 h-5" /> Dados & Backup</h2>
                            <button onClick={() => setShowBackup(false)} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5"/></button>
                            </div>
                            <p className="text-sm text-slate-600 mb-4">Gerencie múltiplos funcionários através do Backup:</p>
                            
                            <div className="space-y-3">
                                <button onClick={handleBackup} className="w-full flex items-center justify-center gap-2 bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition">
                                    <Save className="w-5 h-5" /> Baixar Backup ({config.employeeName.split(' ')[0]})
                                </button>
                                
                                <button onClick={handleReset} className="w-full flex items-center justify-center gap-2 bg-red-100 text-red-700 p-3 rounded-lg hover:bg-red-200 transition border border-red-200">
                                    <Trash2 className="w-5 h-5" /> Zerar / Novo Funcionário
                                </button>
                                
                                <div className="relative pt-2 border-t border-slate-100">
                                    <p className="text-[10px] text-center text-slate-400 mb-2 uppercase font-bold">Trocar Funcionário</p>
                                    <input ref={fileInputRef} type="file" accept=".json" onChange={handleFileChange} className="hidden" />
                                    <button onClick={handleRestoreClick} className="w-full flex items-center justify-center gap-2 bg-slate-200 text-slate-700 p-3 rounded-lg hover:bg-slate-300 transition">
                                        <Upload className="w-5 h-5" /> Restaurar Backup
                                    </button>
                                </div>
                            </div>
                        </div>
                        </div>
                    )}

                    {showConfig && !isExporting && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 overflow-y-auto max-h-[90vh]">
                            <div className="flex justify-between items-center mb-4">
                            <h2 className="text-lg font-bold flex items-center gap-2 text-slate-700"><Settings className="w-5 h-5" /> Configurações</h2>
                            <button onClick={() => setShowConfig(false)} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5"/></button>
                            </div>
                            <div className="space-y-4">
                            <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Empresa</label><input type="text" value={config.companyName} onChange={(e) => setConfig({...config, companyName: e.target.value})} className="w-full border rounded p-2" /></div>
                            <div><label className="block text-xs font-bold text-slate-400 uppercase mb-1">Colaborador</label><input type="text" value={config.employeeName} onChange={(e) => setConfig({...config, employeeName: e.target.value})} className="w-full border rounded p-2" /></div>
                            
                            <div className="bg-slate-100 p-3 rounded-lg border border-slate-200">
                                <label className="flex items-center justify-between cursor-pointer">
                                <div className="flex flex-col">
                                    <span className="text-sm font-bold text-slate-700">Trabalha com Banco de Horas?</span>
                                    <span className="text-[10px] text-slate-500">{config.useTimeBank ? "SIM: Saldo acumula e cobre faltas." : "NÃO: Desconto direto no salário."}</span>
                                </div>
                                <div onClick={() => setConfig({...config, useTimeBank: !config.useTimeBank})} className="relative">
                                    {config.useTimeBank ? <ToggleRight className="w-10 h-10 text-blue-600" /> : <ToggleLeft className="w-10 h-10 text-slate-400" />}
                                </div>
                                </label>
                            </div>

                            <div className="border-t pt-4"><label className="block text-xs font-bold text-slate-400 uppercase mb-2">Metas Diárias</label><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-medium text-slate-600 mb-1">Seg-Qui</label><input type="time" value={config.dailyTargetMonThu} onChange={(e) => setConfig({...config, dailyTargetMonThu: e.target.value})} className="w-full border rounded p-2 text-center" /></div><div><label className="block text-sm font-medium text-slate-600 mb-1">Sexta</label><input type="time" value={config.dailyTargetFri} onChange={(e) => setConfig({...config, dailyTargetFri: e.target.value})} className="w-full border rounded p-2 text-center" /></div></div></div>
                            <div className="border-t pt-4">
                                <label className="block text-xs font-bold text-slate-400 uppercase mb-2">Horários Padrão</label>
                                <div className="grid grid-cols-2 gap-2">
                                <div><label className="block text-[10px] text-slate-500">Entrada</label><input type="time" value={config.defaultStart} onChange={(e) => setConfig({...config, defaultStart: e.target.value})} className="w-full border rounded p-1 text-center" /></div>
                                <div><label className="block text-[10px] text-slate-500">Almoço (Ida)</label><input type="time" value={config.defaultLunchStart} onChange={(e) => setConfig({...config, defaultLunchStart: e.target.value})} className="w-full border rounded p-1 text-center" /></div>
                                <div><label className="block text-[10px] text-slate-500">Almoço (Volta)</label><input type="time" value={config.defaultLunchEnd} onChange={(e) => setConfig({...config, defaultLunchEnd: e.target.value})} className="w-full border rounded p-1 text-center" /></div>
                                <div></div>
                                <div><label className="block text-[10px] text-slate-500">Saída (Seg-Qui)</label><input type="time" value={config.defaultEndMonThu} onChange={(e) => setConfig({...config, defaultEndMonThu: e.target.value})} className="w-full border rounded p-1 text-center" /></div>
                                <div><label className="block text-[10px] text-slate-500">Saída (Sexta)</label><input type="time" value={config.defaultEndFri} onChange={(e) => setConfig({...config, defaultEndFri: e.target.value})} className="w-full border rounded p-1 text-center" /></div>
                                </div>
                            </div>
                            <div className="pt-4 border-t flex justify-end"><button onClick={() => setShowConfig(false)} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 w-full">Salvar Configurações</button></div>
                            </div>
                        </div>
                        </div>
                    )}
                </div>
            );
        }

        // Renderiza o App no elemento root
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
